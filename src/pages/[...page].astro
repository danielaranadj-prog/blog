---
// ==========================================
// üõ°Ô∏è ZONA BLINDADA: IMPORTS Y L√ìGICA DE SERVIDOR
// üîí NO MODIFICAR SIN RESPALDO PREVIO
// ==========================================
import BaseHead from '../components/BaseHead.astro';
import BlogHeader from '../components/BlogHeader.astro'; 
import Hero from '../components/Hero.astro';            
import BlogPostPreview from '../components/BlogPostPreview.astro';
import Footer from '../components/Footer.astro';
import AdBanner from '../components/AdBanner.astro'; 
import HotelWidget from '../components/HotelWidget.astro';
import CookieBanner from '../components/CookieBanner.astro';
import { SITE } from '../config';

// üîí L√ìGICA CR√çTICA DE PAGINACI√ìN DE ASTRO
export async function getStaticPaths({ paginate }) {
  let allPosts = await Astro.glob('./posts/*.md');
  // Ordenar por fecha (M√°s reciente primero)
  allPosts = allPosts.sort((a, b) => new Date(b.frontmatter.publishDate).valueOf() - new Date(a.frontmatter.publishDate).valueOf());
  
  const popularPosts = allPosts.slice(0, 3);

  // Extracci√≥n de etiquetas √∫nicas para el filtro
  const allTags = allPosts.flatMap(post => post.frontmatter.tags || []);
  const uniqueTags = [...new Set(allTags)];
  const displayTags = uniqueTags.slice(0, 15);

  return paginate(allPosts, { 
      pageSize: 12,
      props: { popularPosts, displayTags } 
  });
}

const { page, popularPosts, displayTags } = Astro.props;
let title = SITE.title;
let description = SITE.description;
let permalink = 'https://blog.instantetrips.com/';
const isHomePage = page.currentPage === 1;
// ==========================================
// üîì FIN ZONA BLINDADA
// ==========================================
---

<html lang="es">
    <head>
        <BaseHead {title} {description} {permalink} />

        <style>
            @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;800&display=swap');

            /* üõ°Ô∏è ZONA BLINDADA: VARIABLES GLOBALES (DESIGN SYSTEM)
               üîí Si cambias estos colores, se rompe la identidad visual en toda la p√°gina.
            */
            :root {
                --page-bg: #F8F9FA; 
                --text-main: #2D3748;
                --text-muted: #718096;
                --brand-blue: #75AADB;
                --brand-gold: #F4B942;
                --card-bg: #FFFFFF;
                --card-border: #E2E8F0;
                --max-width: 1600px;
                --title-color: #2D3748;
            }

            @media (prefers-color-scheme: dark) {
                :root {
                    --page-bg: #0f172a; 
                    --text-main: #f1f5f9;
                    --text-muted: #94a3b8;
                    --card-bg: #1e293b;
                    --card-border: #334155;
                    --title-color: #ffffff;
                }
                .profile-circle img {
                    filter: invert(1) brightness(2);
                }
            }
            /* üîì FIN ZONA BLINDADA DE VARIABLES */

            body {
                background-color: var(--page-bg);
                color: var(--text-main);
                font-family: 'Montserrat', sans-serif;
                margin: 0;
            }

            .main-container-centered {
                max-width: var(--max-width); margin: 0 auto; padding: 0 1.5rem; width: 100%; box-sizing: border-box; 
            }

            .ad-container-horizontal {
                width: 100%; display: flex; justify-content: center;
                margin-top: -1.5rem; margin-bottom: 1rem; 
            }

            /* Layout */
            .page-container { display: flex; flex-direction: column; gap: 2.5rem; }
            .main-content { width: 100%; min-width: 0; }
            
            /* üõ°Ô∏è ZONA BLINDADA: GRID RESPONSIVO
               üîí No tocar los breakpoints ni grid-template-columns. 
            */
            .grid-layout { 
                display: grid; 
                grid-template-columns: 1fr; 
                gap: 1rem; 
                row-gap: 1rem; 
            }
            .post-item-wrapper { height: 100%; display: flex; flex-direction: column; }
            .searchable-item { height: 100%; width: 100%; display: flex; flex-direction: column; }
            
            @media (min-width: 640px) { .grid-layout { grid-template-columns: repeat(2, 1fr); } }
            @media (min-width: 1280px) { .grid-layout { grid-template-columns: repeat(3, 1fr); } }
            @media (min-width: 1550px) { .grid-layout { grid-template-columns: repeat(4, 1fr); } }
            /* üîì FIN ZONA GRID */

            @media (min-width: 1024px) {
                .page-container { flex-direction: row; align-items: flex-start; }
                .main-content { flex: 1; }
                .sidebar { width: 300px; min-width: 300px; flex-shrink: 0; position: sticky; top: 85px; }
            }

            /* --- SIDEBAR WIDGETS - PREMIUM UPGRADE --- */
            .sidebar { display: flex; flex-direction: column; gap: 1.5rem; }
            
            .sidebar-widget {
                background: var(--card-bg); 
                border: 1px solid var(--card-border);
                padding: 1.5rem; 
                border-radius: 16px; 
                box-shadow: 0 4px 20px rgba(0,0,0,0.03);
                position: relative;
                overflow: hidden;
                transition: all 0.4s ease;
            }

            .sidebar-widget::before {
                content: '';
                position: absolute;
                inset: 0;
                border-radius: 16px;
                padding: 2px;
                background: linear-gradient(135deg, #F4B942, #75AADB, #F4B942);
                background-size: 200% 200%;
                -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
                mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
                -webkit-mask-composite: xor;
                mask-composite: exclude;
                opacity: 0;
                transition: opacity 0.4s ease;
            }

            .sidebar-widget:hover::before {
                opacity: 1;
                animation: borderGlow 3s linear infinite;
            }

            .sidebar-widget:hover {
                transform: translateY(-3px);
                box-shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
            }

            @keyframes borderGlow {
                0% { background-position: 0% 50%; }
                50% { background-position: 100% 50%; }
                100% { background-position: 0% 50%; }
            }

            /* WIDGET PERFIL */
            .profile-header {
                display: flex; flex-direction: column; align-items: center; margin-bottom: 1rem;
            }
            .profile-circle {
                width: 80px; height: 80px;
                border-radius: 50%;
                background: var(--page-bg);
                border: 3px solid var(--brand-blue);
                padding: 4px;
                margin-bottom: 1rem;
                overflow: hidden;
                display: flex; align-items: center; justify-content: center;
            }
            .profile-circle img {
                width: 100%; height: 100%; object-fit: contain; border-radius: 50%;
                transition: filter 0.3s ease;
            }

            .widget-title {
                font-size: 0.85rem; color: var(--brand-blue); 
                margin-top: 0; margin-bottom: 1rem; padding-bottom: 0.5rem; 
                border-bottom: 2px solid var(--card-border); 
                text-transform: uppercase; font-weight: 800;
                display: flex; align-items: center; gap: 8px;
            }

            /* Search - Enhanced */
            .search-input {
                width: 100%; 
                box-sizing: border-box; 
                padding: 0.85rem 1.2rem; 
                border: 2px solid var(--card-border); 
                border-radius: 12px; 
                font-family: inherit; 
                font-size: 0.9rem;
                background-color: var(--page-bg); 
                color: var(--text-main); 
                margin-bottom: 1rem;
                transition: all 0.3s ease;
            }
            .search-input:focus { 
                outline: none; 
                border-color: var(--brand-blue); 
                box-shadow: 0 0 0 4px rgba(117, 170, 219, 0.15);
                transform: translateY(-1px);
            }
            .search-input::placeholder {
                color: var(--text-muted);
                transition: opacity 0.3s ease;
            }
            .search-input:focus::placeholder {
                opacity: 0.5;
            }

            /* Tags Cloud - Premium */
            .tags-cloud { display: flex; flex-wrap: wrap; gap: 0.6rem; }
            .cat-btn {
                border: 1px solid var(--card-border); 
                background: var(--page-bg); 
                color: var(--text-muted);
                padding: 0.5rem 1rem; 
                border-radius: 25px; 
                font-size: 0.7rem; 
                font-weight: 700; 
                cursor: pointer; 
                text-transform: capitalize; 
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                position: relative;
                overflow: hidden;
            }
            .cat-btn::before {
                content: '';
                position: absolute;
                inset: 0;
                background: linear-gradient(135deg, var(--brand-blue), var(--brand-gold));
                opacity: 0;
                transition: opacity 0.3s ease;
                z-index: -1;
            }
            .cat-btn:hover::before, .cat-btn.active::before { 
                opacity: 1;
            }
            .cat-btn:hover, .cat-btn.active { 
                color: white; 
                border-color: transparent; 
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(117, 170, 219, 0.3);
            }

            #no-results { display: none; text-align: center; padding: 3rem; color: var(--text-muted); }
            
            /* Popular Posts */
            .popular-item a { text-decoration: none; color: inherit; display: flex; gap: 12px; align-items: center; margin-bottom: 1rem; }
            .mini-thumb { width: 55px; height: 55px; border-radius: 8px; object-fit: cover; flex-shrink: 0; }
            .mini-title { font-size: 0.85rem; font-weight: 700; transition: color 0.2s;}
            .popular-item a:hover .mini-title { color: var(--brand-blue); }

            /* Paginaci√≥n */
            .pagination-area {
                margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--card-border);
                display: flex; flex-direction: column; align-items: center; gap: 1.5rem;
                position: relative; z-index: 10; 
            }
            .pagination-wrapper { display: flex; align-items: center; justify-content: center; gap: 3rem; width: 100%; }
            .nav-btn {
                display: inline-flex; align-items: center; gap: 8px; text-decoration: none; 
                font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 2px;
                color: var(--text-muted); transition: all 0.3s ease; border: none; background: none; cursor: pointer;
            }
            .nav-btn:hover { color: var(--brand-blue); transform: translateX(-3px); }
            .nav-btn.next:hover { transform: translateX(3px); }
            .nav-btn.disabled { opacity: 0.3; cursor: default; pointer-events: none; }
            .page-counter { font-family: 'Montserrat', sans-serif; font-size: 1.2rem; color: var(--text-main); font-weight: 400; letter-spacing: 2px; }
            .page-counter .current { font-weight: 800; color: var(--text-main); }
            .page-counter .slash { color: var(--brand-gold); margin: 0 8px; font-weight: 300; }
            .page-counter .total { color: var(--text-muted); font-size: 1rem; }
            .ad-container-bottom { width: 100%; display: flex; flex-direction: column; align-items: center; margin-bottom: 0.5rem; }

            @media (max-width: 600px) {
                .pagination-wrapper { gap: 1.5rem; }
                .nav-btn { font-size: 0.65rem; letter-spacing: 1px; }
                .page-counter { font-size: 1rem; }
            }
        </style>
    </head>

    <body>
        <BlogHeader />
        
        {isHomePage && (
            <Hero />
        )}

        <div class="main-container-centered" id="contenido-principal">
            <main class="content">
                
                <div class="ad-container-horizontal">
                    <AdBanner position="header" />
                </div>

                <div class="page-container">
                    <div class="main-content">
                        <section aria-label="√öltimos art√≠culos">
                            <div class="grid-layout" id="postsGrid">
                                {page.data.map((p) => (
                                    <div class="post-item-wrapper"> 
                                        <div class="searchable-item" data-tags={p.frontmatter.tags ? p.frontmatter.tags.join(',').toLowerCase() : ''}>
                                            <BlogPostPreview post={p} />
                                        </div>
                                    </div>
                                ))}
                                <div id="no-results">
                                    <p>Ups, no encontramos nada aqu√≠. ü§∑‚Äç‚ôÇÔ∏è</p>
                                </div>
                            </div>
                            </section>

                        <div class="pagination-area">
                            <nav class="pagination-wrapper" aria-label="Navegaci√≥n de p√°ginas">
                                {page.url.prev ? (
                                    <a href={page.url.prev} class="nav-btn prev">‚Üê Anterior</a>
                                ) : page.currentPage === 2 ? (
                                    <a href="/" class="nav-btn prev">‚Üê Anterior</a>
                                ) : (
                                    <span class="nav-btn disabled">‚Üê Anterior</span>
                                )}

                                <div class="page-counter">
                                    <span class="current">{page.currentPage}</span>
                                    <span class="slash">/</span>
                                    <span class="total">{page.lastPage}</span>
                                </div>

                                {page.url.next ? (
                                    <a href={page.url.next} class="nav-btn next">Siguiente ‚Üí</a>
                                ) : (
                                    <span class="nav-btn disabled">Siguiente ‚Üí</span>
                                )}
                            </nav>

                            <div class="ad-container-bottom">
                                <AdBanner position="footer" />
                            </div>
                        </div>

                    </div>

                    <aside class="sidebar">
                        
                        <div class="sidebar-widget">
                            <div class="profile-header">
                                <div class="profile-circle">
                                    <img src="/logo.svg" alt="Instante Trips" />
                                </div>
                                <h3 class="widget-title" style="margin:0; border:none; padding:0;">NO SOMOS GUR√öS</h3>
                            </div>
                            
                            <div style="display:flex; flex-direction:column; gap:0.5rem; text-align: justify;">
                                <p style="font-size:0.9rem; line-height:1.6; color:var(--text-muted); margin:0;">
                                    Somos un colectivo de viajeros reales. De los que pierden trenes y piden el plato equivocado.
                                </p>
                                <p style="font-size:0.9rem; line-height:1.6; color:var(--text-main); margin:0;">
                                    Sumamos las experiencias (y los errores) de varias mentes para que t√∫ no tengas que tropezar.
                                </p>
                            </div>
                        </div>

                        <div class="sidebar-widget">
                            <h3 class="widget-title">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/></svg>
                                Explorar
                            </h3>
                            
                            <input type="text" id="searchInput" class="search-input" placeholder="¬øQu√© buscas hoy?" onkeyup="searchPosts()">
                            
                            <div class="tags-cloud">
                                <button class="cat-btn active" onclick="filterPosts('all')">Todo</button>
                                {displayTags.map((tag) => (
                                    <button class="cat-btn" onclick={`filterPosts('${tag.toLowerCase()}')`}>
                                        {tag}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <HotelWidget variant="sidebar" />

                        <div class="sidebar-widget" style="text-align: center; border:none; background:transparent; box-shadow:none;">
                            <AdBanner position="sidebar" />
                        </div>

                        <div class="sidebar-widget">
                            <h3 class="widget-title">M√°s Le√≠dos</h3>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                {popularPosts.map((p) => (
                                    <li>
                                        <div class="popular-item">
                                            <a href={p.url}>
                                                <img src={p.frontmatter.heroImage || p.frontmatter.heroImageLink} class="mini-thumb" alt="" />
                                                <span class="mini-title">{p.frontmatter.title}</span>
                                            </a>
                                        </div>
                                    </li>
                                ))}
                            </ul>
                        </div>
                    </aside>
                </div>
            </main>
        </div> 

        <Footer />
        
        <CookieBanner /> 
        
        <script is:inline>
            // ==========================================
            // üõ°Ô∏è ZONA BLINDADA: CORE LOGIC SCRIPTS
            // üîí La funcionalidad de b√∫squeda y filtrado depende de estos nombres exactos.
            // ==========================================
            function searchPosts() {
                let input = document.getElementById('searchInput').value.toLowerCase();
                let wrappers = document.getElementsByClassName('post-item-wrapper');
                let hasResults = false;
                
                for (let i = 0; i < wrappers.length; i++) {
                    let searchable = wrappers[i].querySelector('.searchable-item');
                    let textContent = wrappers[i].innerText.toLowerCase();
                    let tags = searchable ? searchable.getAttribute('data-tags') : '';
                    
                    if (textContent.includes(input) || tags.includes(input)) { 
                        wrappers[i].style.display = "flex"; 
                        hasResults = true; 
                    } else { 
                        wrappers[i].style.display = "none"; 
                    }
                }
                document.getElementById('no-results').style.display = hasResults ? "none" : "block";
            }

            function filterPosts(tag) {
                let buttons = document.getElementsByClassName('cat-btn');
                for(let btn of buttons) {
                    btn.classList.remove('active');
                    if(btn.innerText.toLowerCase() === tag || (tag === 'all' && btn.innerText === 'Todo')) {
                        btn.classList.add('active');
                    }
                }
                let input = document.getElementById('searchInput');
                if (tag === 'all') {
                    input.value = '';
                    searchPosts();
                } else {
                    input.value = tag;
                    searchPosts();
                }
            }
            // ==========================================
            // üîì FIN ZONA BLINDADA SCRIPTS
            // ==========================================
        </script>
    </body>
</html>