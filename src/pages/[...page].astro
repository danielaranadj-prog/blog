---
// Component Imports
import BaseHead from '../components/BaseHead.astro';
import BlogHeader from '../components/BlogHeader.astro';
import BlogPostPreview from '../components/BlogPostPreview.astro';
import Footer from '../components/Footer.astro';
import { SITE } from '../config';

// --- MAGIA DE PAGINACI√ìN (Astro) ---
export async function getStaticPaths({ paginate }) {
  let allPosts = await Astro.glob('./posts/*.md');
  allPosts = allPosts.sort((a, b) => new Date(b.frontmatter.publishDate).valueOf() - new Date(a.frontmatter.publishDate).valueOf());
  const popularPosts = allPosts.slice(0, 3);

  return paginate(allPosts, { 
      pageSize: 12,
      props: { popularPosts }
  });
}

const { page, popularPosts } = Astro.props;

// --- CORRECCI√ìN: USO DE VARIABLES GLOBALES ---
// Usamos SITE.title y SITE.description (definidos en config.ts)
// para que el navegador y Google lean el nombre nuevo correctamente.
let title = SITE.title;
let description = SITE.description;
let permalink = 'https://blog.instantetrips.com/';
---

<html lang="es">
    <head>
        <BaseHead {title} {description} {permalink} />

        <style>
            @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap');

            :root {
                --page-bg: #F8F9FA; 
                --text-main: #2D3748;
                --text-muted: #718096;
                --brand-blue: #75AADB;
                --accent-gold: #F4B942;
                --card-bg: #FFFFFF;
                --card-border: #E2E8F0;
                --max-width: 1600px;
                --nav-btn-bg: #FFFFFF;
                --title-color: #2D3748;
            }

            @media (prefers-color-scheme: dark) {
                :root {
                    --page-bg: #0f172a; 
                    --text-main: #f1f5f9;
                    --text-muted: #94a3b8;
                    --card-bg: #1e293b;
                    --card-border: #334155;
                    --nav-btn-bg: #1e293b;
                    --title-color: #ffffff;
                }
            }

            :global(header) {
                padding-bottom: 0.2rem !important;
                margin-bottom: 0 !important;
                background-color: var(--card-bg) !important;
                color: var(--text-main) !important;
                border-bottom: 1px solid var(--card-border) !important;
            }

            body {
                background-color: var(--page-bg);
                color: var(--text-main);
                font-family: 'Montserrat', sans-serif;
                margin: 0;
            }

            /* --- SOLUCI√ìN PARA IM√ÅGENES Y L√çNEAS NEGRAS --- */
            .post-item-wrapper :global(.post-preview__img-container), 
            .post-item-wrapper :global(picture),
            .post-item-wrapper :global(div) {
                background-color: transparent !important;
                background: none !important;
            }

            .post-item-wrapper :global(img) {
                width: 100% !important;
                height: 220px !important;
                object-fit: cover !important;
                object-position: center !important;
                display: block !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            /* --- SOLUCI√ìN PARA TITULARES INVISIBLES --- */
            .post-item-wrapper :global(h1),
            .post-item-wrapper :global(h2),
            .post-item-wrapper :global(h3),
            .post-item-wrapper :global(a),
            .post-item-wrapper :global(.title),
            .post-item-wrapper :global(.post-preview__title) { 
                color: var(--title-color) !important;
                text-decoration: none !important;
            }
            
            .post-item-wrapper :global(p),
            .post-item-wrapper :global(.description),
            .post-item-wrapper :global(time),
            .post-item-wrapper :global(.post-preview__date) {
                color: var(--text-muted) !important;
            }

            /* --- HERO --- */
            .hero-compact {
                position: relative; width: 100%; height: 30vh; min-height: 220px;
                display: flex; align-items: center; justify-content: center;
                background-color: var(--brand-blue); overflow: hidden;
            }

            .overlay-gradient {
                position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;
                background-image: linear-gradient(to bottom, rgba(9, 42, 94, 0.6), rgba(117, 170, 219, 0.4)), url('/hero-bg.jpg');
                background-size: cover; background-position: center; 
            }

            .hero-content { 
                position: relative; z-index: 2; text-align: center; padding: 0 20px; 
                display: flex; flex-direction: column; align-items: center;
            }
            
            .hero-tagline {
                font-size: clamp(0.8rem, 1.5vw, 1rem); font-weight: 600; color: var(--accent-gold); 
                text-transform: uppercase; letter-spacing: 3px; margin-bottom: 0.2rem; text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            }

            .hero-title-main { 
                font-size: clamp(2rem, 5vw, 3.5rem); font-weight: 800; color: #ffffff; 
                margin: 0; line-height: 1; text-shadow: 0 4px 20px rgba(0,0,0,0.4); text-transform: uppercase;
            }

            .main-container-centered {
                max-width: var(--max-width); margin: 0 auto; padding: 0 1.5rem; width: 100%; box-sizing: border-box; 
            }

            .ad-container-horizontal {
                width: 100%; margin: 1.5rem 0 2rem 0; display: flex; justify-content: center;
            }
            .ad-banner-img {
                max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); object-fit: contain;
            }

            .page-container { display: flex; flex-direction: column; gap: 2.5rem; }
            .main-content { width: 100%; min-width: 0; }
            .grid-layout {
                display: grid; grid-template-columns: 1fr; gap: 1.5rem; row-gap: 3rem; 
            }

            @media (min-width: 640px) { .grid-layout { grid-template-columns: repeat(2, 1fr); } }
            @media (min-width: 1024px) {
                .page-container { flex-direction: row; align-items: flex-start; }
                .main-content { flex: 1; }
                .sidebar { width: 300px; min-width: 300px; flex-shrink: 0; position: sticky; top: 1.5rem; }
                .grid-layout { grid-template-columns: repeat(2, 1fr); }
            }
            @media (min-width: 1280px) { .grid-layout { grid-template-columns: repeat(3, 1fr); } }
            @media (min-width: 1550px) { .grid-layout { grid-template-columns: repeat(4, 1fr); } }

            .post-item-wrapper { display: flex; flex-direction: column; height: 100%; }

            .pagination-wrapper {
                display: flex; justify-content: center; align-items: center; gap: 2rem; margin: 4rem 0;
                padding-top: 2rem; border-top: 1px solid var(--card-border);
            }
            .nav-btn {
                text-decoration: none; padding: 0.8rem 1.8rem; border-radius: 50px; 
                background: var(--nav-btn-bg); border: 2px solid var(--brand-blue); 
                color: var(--brand-blue); font-weight: 700; transition: all 0.3s ease; 
                display: flex; align-items: center; gap: 8px;
            }
            .nav-btn:hover {
                background: var(--brand-blue); color: white; transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(117, 170, 219, 0.3);
            }
            .page-count {
                color: var(--text-main); font-size: 1rem; font-weight: 800;
                background: var(--card-border); padding: 0.5rem 1.2rem; border-radius: 20px;
            }

            .sidebar { display: flex; flex-direction: column; gap: 1.5rem; }
            .sidebar-widget {
                background: var(--card-bg); border: 1px solid var(--card-border);
                padding: 1.5rem; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.03);
                box-sizing: border-box;
            }
            .widget-title {
                font-size: 0.9rem; color: var(--brand-blue); margin-top: 0; margin-bottom: 1rem;
                padding-bottom: 0.5rem; border-bottom: 2px solid var(--card-border); text-transform: uppercase; letter-spacing: 1.2px; font-weight: 800;
            }

            .search-input {
                width: 100%; padding: 0.8rem; border: 1px solid var(--card-border);
                border-radius: 8px; font-family: 'Montserrat', sans-serif; font-size: 0.9rem;
                color: var(--text-main); background-color: var(--page-bg); margin-bottom: 1rem;
                box-sizing: border-box; 
            }
            .search-input:focus { outline: none; border-color: var(--brand-blue); background-color: var(--card-bg); }

            .tags-cloud { display: flex; flex-wrap: wrap; gap: 0.5rem; }
            .cat-btn {
                border: 1px solid var(--card-border); background: var(--card-bg); color: var(--text-muted);
                padding: 0.4rem 0.8rem; border-radius: 8px; font-size: 0.75rem; font-weight: 600;
                cursor: pointer; transition: all 0.2s ease; font-family: 'Montserrat', sans-serif;
            }
            .cat-btn:hover, .cat-btn.active { background: var(--brand-blue); color: white; border-color: var(--brand-blue); }

            .popular-item a { text-decoration: none; color: inherit; display: flex; gap: 12px; align-items: center; }
            .mini-thumb { width: 55px; height: 55px; border-radius: 8px; object-fit: cover; flex-shrink: 0; }
            .mini-title { font-size: 0.85rem; line-height: 1.3; color: var(--text-main); font-weight: 700; }
            .sidebar-text { font-size: 0.85rem; color: var(--text-muted); line-height: 1.6; }
            #no-results { display: none; grid-column: 1 / -1; text-align: center; padding: 3rem; color: var(--text-muted); }
        </style>
    </head>

    <body>
        <BlogHeader />
        
        <div class="wrapper">
            <header class="hero-compact">
                <div class="overlay-gradient"></div>
                <div class="hero-content">
                    <span class="hero-tagline">BLOG DE VIAJES</span>
                    <h1 class="hero-title-main">INSTANTE TRIPS <span style="font-weight:400; color:#F4B942;">&</span> TIPS</h1>
                </div>
            </header>

            <div class="main-container-centered">
                <main class="content">
                    <div class="ad-container-horizontal">
                        <img 
                            src="https://placehold.co/728x90/75AADB/ffffff?text=OFERTA+VUELOS+INTERNACIONALES+-40%25" 
                            alt="Anuncio" 
                            class="ad-banner-img"
                        />
                    </div>

                    <div class="page-container">
                        <div class="main-content">
                            <section aria-label="√öltimos art√≠culos">
                                <div class="grid-layout" id="postsGrid">
                                    {page.data.map((p) => (
                                        <div class="post-item-wrapper"> 
                                            <BlogPostPreview post={p} />
                                        </div>
                                    ))}
                                    <div id="no-results">
                                        <p>Ups, no encontramos nada aqu√≠. ü§∑‚Äç‚ôÇÔ∏è</p>
                                    </div>
                                </div>
                            </section>

                           <nav class="pagination-wrapper">
                                {/* BOT√ìN ANTERIOR: Si estamos en p√°gina 2 o m√°s, mostramos el bot√≥n a la fuerza */}
                                {page.currentPage > 1 ? (
                                    <a href={page.url.prev || '/'} class="nav-btn">‚Üê Anterior</a>
                                ) : (
                                    <div class="spacer"></div>
                                )}

                                <span class="page-count">{page.currentPage} / {page.lastPage}</span>

                                {/* BOT√ìN SIGUIENTE */}
                                {page.url.next ? (
                                    <a href={page.url.next} class="nav-btn">Siguiente ‚Üí</a>
                                ) : (
                                    <div class="spacer"></div>
                                )}
                            </nav>
                        </div>

                        <aside class="sidebar">
                            <div class="sidebar-widget">
                                <h3 class="widget-title">Quienes somos</h3>
                                <p class="sidebar-text">Instante Trips and Tips es un blog para viajeros reales basado en experiencia directa.</p>
                            </div>
                            <div class="sidebar-widget">
                                <h3 class="widget-title">Explorar</h3>
                                <input type="text" id="searchInput" class="search-input" placeholder="Buscar..." onkeyup="searchPosts()">
                                <div class="tags-cloud">
                                    <button class="cat-btn active" onclick="filterPosts('all')">Todo</button>
                                    <button class="cat-btn" onclick="filterPosts('europa')">Europa</button>
                                    <button class="cat-btn" onclick="filterPosts('comida')">Comida</button>
                                </div>
                            </div>
                            <div class="sidebar-widget">
                                <h3 class="widget-title">M√°s Le√≠dos</h3>
                                <ul style="list-style: none; padding: 0; margin: 0;">
                                    {popularPosts.map((p) => (
                                        <li style="margin-bottom: 1rem;">
                                            <div class="popular-item">
                                                <a href={p.url}>
                                                    <img src={p.frontmatter.heroImage || p.frontmatter.heroImageLink} class="mini-thumb" alt="" />
                                                    <span class="mini-title">{p.frontmatter.title}</span>
                                                </a>
                                            </div>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        </aside>
                    </div>
                </main>
            </div> 
        </div>

        <Footer />
        
        <script is:inline>
            function searchPosts() {
                let input = document.getElementById('searchInput').value.toLowerCase();
                let cards = document.getElementsByClassName('post-item-wrapper');
                let hasResults = false;
                for (let i = 0; i < cards.length; i++) {
                    let textContent = cards[i].innerText.toLowerCase();
                    if (textContent.includes(input)) { cards[i].style.display = "flex"; hasResults = true; }
                    else { cards[i].style.display = "none"; }
                }
                document.getElementById('no-results').style.display = hasResults ? "none" : "block";
            }
            function filterPosts(category) {
                document.getElementById('searchInput').value = category === 'all' ? '' : category;
                searchPosts();
            }
        </script>
    </body>
</html>