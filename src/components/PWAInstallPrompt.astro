---
// PWA Install Prompt Component
// Shows a native-like banner to install the PWA
---

<div id="pwa-install-prompt" class="install-prompt hidden">
    <div class="prompt-content">
        <div class="prompt-icon">✈️</div>
        <div class="prompt-text">
            <h3>Instalar Instante Trips</h3>
            <p>Accede más rápido desde tu pantalla de inicio</p>
        </div>
        <div class="prompt-actions">
            <button id="install-btn" class="btn-install">Instalar</button>
            <button id="dismiss-btn" class="btn-dismiss">Ahora no</button>
        </div>
    </div>
</div>

<style>
    .install-prompt {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 9999;
        max-width: 420px;
        width:calc(100% - 40px);
        background: rgba(255, 255, 255, 0.98);
        border-radius: 16px;
        box-shadow: 
            0 20px 40px rgba(0, 0, 0, 0.15),
            0 0 0 1px rgba(0, 0, 0, 0.05);
        backdrop-filter: blur(10px);
        animation: slideUp 0.4s cubic-bezier(0.4, 0.0, 0.2, 1);
    }

    :root[data-theme="dark"] .install-prompt {
        background: rgba(30, 41, 59, 0.98);
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 
            0 20px 40px rgba(0, 0, 0, 0.4),
            0 0 0 1px rgba(255, 255, 255, 0.05);
    }

    .install-prompt.hidden {
        display: none;
    }

    .prompt-content {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 20px;
    }

    .prompt-icon {
        font-size: 40px;
        flex-shrink: 0;
    }

    .prompt-text {
        flex: 1;
    }

    .prompt-text h3 {
        margin: 0 0 4px;
        font-size: 16px;
        font-weight: 700;
        color: var(--text-main, #2D3748);
    }

    .prompt-text p {
        margin: 0;
        font-size: 13px;
        color: var(--text-muted, #718096);
    }

    .prompt-actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
        flex-shrink: 0;
    }

    .btn-install, .btn-dismiss {
        padding: 10px 20px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 700;
        cursor: pointer;
        border: none;
        transition: all 0.2s;
        white-space: nowrap;
    }

    .btn-install {
        background: linear-gradient(135deg, #F4B942, #f59e0b);
        color: #0f172a;
    }

    .btn-install:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(244, 185, 66, 0.3);
    }

    .btn-dismiss {
        background: transparent;
        color: var(--text-muted, #718096);
    }

    .btn-dismiss:hover {
        background: rgba(0, 0, 0, 0.05);
    }

    :root[data-theme="dark"] .btn-dismiss:hover {
        background: rgba(255, 255, 255, 0.05);
    }

    @keyframes slideUp {
        from {
            transform: translateX(-50%) translateY(100px);
            opacity: 0;
        }
        to {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
    }

    /* Mobile adjustments */
    @media (max-width: 640px) {
        .prompt-content {
            flex-wrap: wrap;
        }
        
        .prompt-actions {
            flex-direction: row;
            width: 100%;
        }
        
        .btn-install, .btn-dismiss {
            flex: 1;
        }
    }
</style>

<script>
let deferredPrompt: Event | null = null;

// Capture the install prompt event
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    
    // Check if user has dismissed the prompt before
    const dismissed = localStorage.getItem('pwa-prompt-dismissed');
    
    if (!dismissed) {
        // Show our custom prompt after a short delay
        setTimeout(() => {
            const prompt = document.getElementById('pwa-install-prompt');
            if (prompt) {
                prompt.classList.remove('hidden');
            }
        }, 3000); // Show after 3 seconds
    }
});

// Install button clicked
document.getElementById('install-btn')?.addEventListener('click', async () => {
    if (!deferredPrompt) return;
    
    // Show the native install prompt
    (deferredPrompt as any).prompt();
    
    // Wait for the user's response
    const choiceResult = await (deferredPrompt as any).userChoice;
    
    console.log(`[PWA] User ${choiceResult.outcome === 'accepted' ? 'accepted' : 'dismissed'} the install prompt`);
    
    // Hide our custom prompt
    const prompt = document.getElementById('pwa-install-prompt');
    if (prompt) {
        prompt.classList.add('hidden');
    }
    
    deferredPrompt = null;
});

// Dismiss button clicked
document.getElementById('dismiss-btn')?.addEventListener('click', () => {
    // Hide the prompt
    const prompt = document.getElementById('pwa-install-prompt');
    if (prompt) {
        prompt.classList.add('hidden');
    }
    
    // Remember that user dismissed it (for 7 days)
    const expiryDate = new Date();
    expiryDate.setDate(expiryDate.getDate() + 7);
    localStorage.setItem('pwa-prompt-dismissed', expiryDate.toISOString());
});

// Log when app is installed
window.addEventListener('appinstalled', () => {
    console.log('[PWA] App was installed successfully');
    deferredPrompt = null;
    
    // Hide the prompt if it's still visible
    const prompt = document.getElementById('pwa-install-prompt');
    if (prompt) {
        prompt.classList.add('hidden');
    }
});
</script>
