---
/**
 * SearchBar.astro
 * Intelligent search bar for blog posts, destinations, and categories
 * Keyboard shortcuts: Cmd+K / Ctrl+K / /
 */
---

<div class="search-overlay" id="search-overlay">
  <div class="search-modal">
    <div class="search-header">
      <div class="search-input-wrapper">
        <i class="fas fa-search search-icon"></i>
        <input 
          type="text" 
          id="search-input" 
          class="search-input" 
          placeholder="Buscar posts, destinos, categorÃ­as..."
          autocomplete="off"
          spellcheck="false"
        />
        <kbd class="search-kbd">ESC</kbd>
      </div>
    </div>
    
    <div class="search-body">
      <div class="search-recent" id="search-recent" style="display: none;">
        <div class="search-section-title">
          <i class="fas fa-history"></i> BÃºsquedas recientes
        </div>
        <div class="search-results" id="recent-searches"></div>
      </div>
      
      <div class="search-results-container" id="search-results">
        <div class="search-empty" id="search-empty">
          <i class="fas fa-search search-empty-icon"></i>
          <p>Busca posts, destinos o categorÃ­as</p>
          <div class="search-tips">
            <span class="search-tip">Prueba: "Patagonia"</span>
            <span class="search-tip">Prueba: "Consejos"</span>
            <span class="search-tip">Prueba: "Viajes"</span>
          </div>
        </div>
        
        <div class="search-results-list" id="results-list" style="display: none;"></div>
      </div>
    </div>
    
    <div class="search-footer">
      <div class="search-footer-item">
        <kbd>â†‘</kbd><kbd>â†“</kbd> Navegar
      </div>
      <div class="search-footer-item">
        <kbd>â†µ</kbd> Seleccionar
      </div>
      <div class="search-footer-item">
        <kbd>ESC</kbd> Cerrar
      </div>
    </div>
  </div>
</div>

<script>
  function initSearch() {
    const overlay = document.getElementById('search-overlay');
    const input = document.getElementById('search-input');
    const resultsContainer = document.getElementById('results-list');
    const emptyState = document.getElementById('search-empty');
    const recentSection = document.getElementById('search-recent');
    const recentSearches = document.getElementById('recent-searches');
    
    if (!overlay || !input) return;
    
    let searchData = [];
    let recentSearchesData = JSON.parse(localStorage.getItem('blogRecentSearches') || '[]');
    let selectedIndex = -1;
    
    // Build search index
    function buildSearchIndex() {
      const items = [];
      
      // Blog posts
      document.querySelectorAll('[data-search-post]').forEach(el => {
        const tags = el.getAttribute('data-search-tags') || '';
        items.push({
          type: 'post',
          title: el.getAttribute('data-search-post'),
          url: el.getAttribute('href') || el.getAttribute('data-search-url'),
          icon: 'ðŸ“',
          description: el.getAttribute('data-search-desc') || '',
          tags: tags
        });
      });
      
      // Destinations
      document.querySelectorAll('[data-search-destination]').forEach(el => {
        items.push({
          type: 'destination',
          title: el.getAttribute('data-search-destination'),
          url: el.getAttribute('href'),
          icon: 'ðŸ“',
          description: el.getAttribute('data-search-desc') || ''
        });
      });
      
      // Categories
      document.querySelectorAll('[data-search-category]').forEach(el => {
        items.push({
          type: 'category',
          title: el.getAttribute('data-search-category'),
          url: el.getAttribute('href'),
          icon: 'ðŸ·ï¸',
          description: el.getAttribute('data-search-desc') || ''
        });
      });
      
      searchData = items;
    }
    
    // Open search
    function openSearch() {
      overlay.classList.add('search-open');
      document.body.style.overflow = 'hidden';
      setTimeout(() => input.focus(), 100);
      showRecent();
    }
    
    // Close search
    function closeSearch() {
      overlay.classList.remove('search-open');
      document.body.style.overflow = '';
      input.value = '';
      resultsContainer.innerHTML = '';
      resultsContainer.style.display = 'none';
      emptyState.style.display = 'block';
      selectedIndex = -1;
    }
    
    // Show recent searches
    function showRecent() {
      if (recentSearchesData.length === 0) {
        recentSection.style.display = 'none';
        return;
      }
      
      recentSection.style.display = 'block';
      recentSearches.innerHTML = recentSearchesData.slice(0, 5).map((search, index) => `
        <div class="search-result-item" data-recent-index="${index}">
          <i class="fas fa-history result-icon"></i>
          <div class="result-content">
            <div class="result-title">${search}</div>
          </div>
        </div>
      `).join('');
      
      recentSearches.querySelectorAll('.search-result-item').forEach(el => {
        el.addEventListener('click', () => {
          const query = recentSearchesData[el.getAttribute('data-recent-index')];
          input.value = query;
          performSearch(query);
        });
      });
    }
    
    // Perform search
    function performSearch(query) {
      if (!query || query.length < 2) {
        resultsContainer.style.display = 'none';
        emptyState.style.display = 'block';
        recentSection.style.display = recentSearchesData.length > 0 ? 'block' : 'none';
        return;
      }
      
      const lowerQuery = query.toLowerCase();
      const results = searchData.filter(item => 
        item.title.toLowerCase().includes(lowerQuery) ||
        item.description.toLowerCase().includes(lowerQuery) ||
        (item.tags && item.tags.toLowerCase().includes(lowerQuery))
      ).slice(0, 8);
      
      if (results.length === 0) {
        resultsContainer.innerHTML = `
          <div class="search-no-results">
            <i class="fas fa-search"></i>
            <p>No se encontraron resultados para "${query}"</p>
          </div>
        `;
        resultsContainer.style.display = 'block';
        emptyState.style.display = 'none';
        recentSection.style.display = 'none';
        return;
      }
      
      resultsContainer.innerHTML = results.map((result, index) => `
        <a href="${result.url}" class="search-result-item ${index === 0 ? 'selected' : ''}" data-result-index="${index}">
          <span class="result-icon">${result.icon}</span>
          <div class="result-content">
            <div class="result-title">${highlightMatch(result.title, query)}</div>
            ${result.description ? `<div class="result-desc">${highlightMatch(truncate(result.description, 80), query)}</div>` : ''}
          </div>
          <span class="result-type">${result.type}</span>
        </a>
      `).join('');
      
      resultsContainer.style.display = 'block';
      emptyState.style.display = 'none';
      recentSection.style.display = 'none';
      selectedIndex = 0;
      
      addToRecent(query);
    }
    
    function highlightMatch(text, query) {
      const regex = new RegExp(`(${query})`, 'gi');
      return text.replace(regex, '<mark>$1</mark>');
    }
    
    function truncate(text, length) {
      return text.length > length ? text.substring(0, length) + '...' : text;
    }
    
    function addToRecent(query) {
      if (!recentSearchesData.includes(query)) {
        recentSearchesData.unshift(query);
        recentSearchesData = recentSearchesData.slice(0, 10);
        localStorage.setItem('blogRecentSearches', JSON.stringify(recentSearchesData));
      }
    }
    
    function navigate(direction) {
      const items = resultsContainer.querySelectorAll('.search-result-item');
      if (items.length === 0) return;
      
      items[selectedIndex]?.classList.remove('selected');
      
      if (direction === 'down') {
        selectedIndex = (selectedIndex + 1) % items.length;
      } else {
        selectedIndex = selectedIndex <= 0 ? items.length - 1 : selectedIndex - 1;
      }
      
      items[selectedIndex]?.classList.add('selected');
      items[selectedIndex]?.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
    }
    
    function selectCurrent() {
      const items = resultsContainer.querySelectorAll('.search-result-item');
      const selected = items[selectedIndex];
      if (selected) {
        selected.click();
      }
    }
    
    // Event listeners
    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        openSearch();
      }
      
      if (e.key === 'Escape' && overlay.classList.contains('search-open')) {
        closeSearch();
      }
    });
    
    document.addEventListener('keydown', (e) => {
      if (e.key === '/' && !overlay.classList.contains('search-open') && 
          document.activeElement.tagName !== 'INPUT' && 
          document.activeElement.tagName !== 'TEXTAREA') {
        e.preventDefault();
        openSearch();
      }
    });
    
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) {
        closeSearch();
      }
    });
    
    input.addEventListener('input', (e) => {
      performSearch(e.target.value);
    });
    
    input.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        navigate('down');
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        navigate('up');
      } else if (e.key === 'Enter') {
        e.preventDefault();
        selectCurrent();
      }
    });
    
    buildSearchIndex();
    document.addEventListener('astro:page-load', buildSearchIndex);
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSearch);
  } else {
    initSearch();
  }
  
  document.addEventListener('astro:page-load', initSearch);
</script>

<style>
  .search-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
    z-index: 10002;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding: 80px 20px 20px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }
  
  .search-overlay.search-open {
    opacity: 1;
    pointer-events: all;
  }
  
  .search-modal {
    width: 100%;
    max-width: 600px;
    background: white;
    border-radius: 16px;
    box-shadow: 0 20px 80px rgba(0, 0, 0, 0.3);
    transform: translateY(-20px);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    max-height: calc(100vh - 160px);
    display: flex;
    flex-direction: column;
  }
  
  .search-open .search-modal {
    transform: translateY(0);
  }
  
  @media (prefers-color-scheme: dark) {
    .search-modal {
      background: #1e293b;
    }
  }
  
  .search-header {
    padding: 20px;
    border-bottom: 1px solid #E2E8F0;
  }
  
  @media (prefers-color-scheme: dark) {
    .search-header {
      border-bottom-color: #334155;
    }
  }
  
  .search-input-wrapper {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .search-icon {
    color: #718096;
    font-size: 1.2rem;
  }
  
  .search-input {
    flex: 1;
    border: none;
    background: transparent;
    font-size: 1.1rem;
    color: #2D3748;
    outline: none;
    font-weight: 500;
  }
  
  @media (prefers-color-scheme: dark) {
    .search-input {
      color: #f1f5f9;
    }
  }
  
  .search-input::placeholder {
    color: #718096;
  }
  
  .search-kbd {
    padding: 4px 8px;
    background: #F8F9FA;
    border: 1px solid #E2E8F0;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    color: #718096;
    font-family: monospace;
  }
  
  @media (prefers-color-scheme: dark) {
    .search-kbd {
      background: #0f172a;
      border-color: #334155;
    }
  }
  
  .search-body {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
  }
  
  .search-section-title {
    padding: 10px 15px;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #718096;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .search-empty {
    text-align: center;
    padding: 60px 20px;
    color: #718096;
  }
  
  .search-empty-icon {
    font-size: 3rem;
    margin-bottom: 20px;
    opacity: 0.3;
  }
  
  .search-empty p {
    margin: 0 0 20px 0;
    font-size: 0.95rem;
  }
  
  .search-tips {
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
  }
  
  .search-tip {
    padding: 6px 12px;
    background: #F8F9FA;
    border-radius: 16px;
    font-size: 0.8rem;
    color: #718096;
  }
  
  @media (prefers-color-scheme: dark) {
    .search-tip {
      background: #0f172a;
    }
  }
  
  .search-results-list {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  
  .search-result-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 15px;
    border-radius: 10px;
    text-decoration: none;
    color: #2D3748;
    transition: background 0.2s ease;
    cursor: pointer;
  }
  
  @media (prefers-color-scheme: dark) {
    .search-result-item {
      color: #f1f5f9;
    }
  }
  
  .search-result-item:hover,
  .search-result-item.selected {
    background: #F8F9FA;
  }
  
  @media (prefers-color-scheme: dark) {
    .search-result-item:hover,
    .search-result-item.selected {
      background: #0f172a;
    }
  }
  
  .result-icon {
    font-size: 1.3rem;
    flex-shrink: 0;
  }
  
  .result-content {
    flex: 1;
    min-width: 0;
  }
  
  .result-title {
    font-weight: 600;
    font-size: 0.95rem;
    margin-bottom: 2px;
  }
  
  .result-title :global(mark) {
    background: rgba(244, 185, 66, 0.3);
    color: inherit;
    padding: 0 2px;
    border-radius: 2px;
  }
  
  .result-desc {
    font-size: 0.8rem;
    color: #718096;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  
  .result-type {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #718096;
    background: rgba(0, 0, 0, 0.05);
    padding: 3px 8px;
    border-radius: 8px;
    flex-shrink: 0;
  }
  
  @media (prefers-color-scheme: dark) {
    .result-type {
      background: rgba(255, 255, 255, 0.1);
    }
  }
  
  .search-no-results {
    text-align: center;
    padding: 40px 20px;
    color: #718096;
  }
  
  .search-no-results i {
    font-size: 2.5rem;
    margin-bottom: 15px;
    opacity: 0.3;
  }
  
  .search-footer {
    border-top: 1px solid #E2E8F0;
    padding: 12px 20px;
    display: flex;
    justify-content: center;
    gap: 20px;
    flex-wrap: wrap;
  }
  
  @media (prefers-color-scheme: dark) {
    .search-footer {
      border-top-color: #334155;
    }
  }
  
  .search-footer-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.8rem;
    color: #718096;
  }
  
  .search-footer-item kbd {
    padding: 3px 6px;
    background: #F8F9FA;
    border: 1px solid #E2E8F0;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 600;
    font-family: monospace;
  }
  
  @media (prefers-color-scheme: dark) {
    .search-footer-item kbd {
      background: #0f172a;
      border-color: #334155;
    }
  }
  
  @media (max-width: 768px) {
    .search-overlay {
      padding: 60px 10px 10px;
    }
    
    .search-modal {
      max-height: calc(100vh - 70px);
    }
    
    .search-header {
      padding: 15px;
    }
    
    .search-input {
      font-size: 1rem;
    }
  }
</style>
