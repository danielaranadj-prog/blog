---
// ==========================================
// üõ°Ô∏è ZONA BLINDADA: IMPORTS Y CONFIGURACI√ìN
// üîí No mover el orden de estos imports.
// ==========================================
import BaseHead from '../components/BaseHead.astro';
import BlogHeader from '../components/BlogHeader.astro';
import Footer from '../components/Footer.astro';
import AdBanner from '../components/AdBanner.astro';
import FlightSearch from '../components/FlightSearch.astro';
import HotelWidget from '../components/HotelWidget.astro';
import ToursWidget from '../components/ToursWidget.astro';
import Analytics from '../components/Analytics.astro';
import Newsletter from '../components/Newsletter.astro';
import TableOfContents from '../components/TableOfContents.astro';
import StructuredData from '../components/StructuredData.astro';
import Breadcrumbs from '../components/Breadcrumbs.astro';
import ReadingProgress from '../components/ReadingProgress.astro';
import BackToTop from '../components/BackToTop.astro';
import ImageLightbox from '../components/ImageLightbox.astro';
import SocialShare from '../components/SocialShare.astro';
import PWAInstallPrompt from '../components/PWAInstallPrompt.astro';
import { AUTHORS, DEFAULT_AUTHOR } from '../data/authors';
import { fetchAffiliates } from '../lib/fetchAffiliates'; // Import fetcher

const {
  content = {},
  frontmatter = {},
} = Astro.props;

// Fetch Affiliates Config (Build time)
const affiliatesConfig = await fetchAffiliates();
const bookingId = affiliatesConfig?.booking?.affiliateId || '2424850';
const skyscannerTag = affiliatesConfig?.skyscanner?.affiliateTag || 'instante_trips';
const civitatisId = affiliatesConfig?.civitatis?.affiliateId || '12345';
const toursProvider = affiliatesConfig?.civitatis?.enabled ? 'civitatis' : 'getyourguide';

// ==========================================
// üõ°Ô∏è ZONA BLINDADA: L√ìGICA DE NEGOCIO
// üîí Procesamiento de datos del post y autor
// ==========================================
const post = {
  title: frontmatter.title || content.title,
  description: frontmatter.description || content.description,
  publishDate: frontmatter.publishDate || content.publishDate,
  heroImage: frontmatter.heroImage || content.heroImage,
  heroImageLink: frontmatter.heroImageLink || content.heroImageLink,
  alt: frontmatter.alt || content.alt || frontmatter.title,
  authorSlug: frontmatter.author, 
  
  // Datos Referidos (Afiliados)
  affiliateTitle: frontmatter.affiliateTitle || content.affiliateTitle, 
  affiliateLink: frontmatter.affiliateLink || content.affiliateLink,
  affiliateText: frontmatter.affiliateText || "Reserva directa al mejor precio",

  // Datos para Widgets Autom√°ticos
  flightDestination: frontmatter.flight_destination,
  tourCity: frontmatter.tour_city,
  tourCountry: frontmatter.tour_country, // Opcional, para contexto
};

// Selecci√≥n de Autor (Fallback System)
const author = (post.authorSlug && AUTHORS[post.authorSlug]) || DEFAULT_AUTHOR;
const authorRole = author.role || "Colaborador"; 
const authorBio = author.bio || "Viajero y narrador de historias en Instante Trips.";

const finalImage = post.heroImage || post.heroImageLink;
const permalink = Astro.url.href;
const encodedUrl = encodeURIComponent(permalink);
const encodedTitle = encodeURIComponent(post.title);

// Calculate reading time (words per minute: 200)
const slotContent = await Astro.slots.render('default');
const words = slotContent.replace(/<[^>]*>/g, '').split(/\s+/).filter(w => w.length > 0).length;
const readingTime = Math.ceil(words / 200);

// ==========================================
// üîì FIN ZONA L√ìGICA
// ==========================================
---

<html lang="es">
<head>
  <BaseHead
    title={post.title}
    description={post.description}
    permalink={permalink}
    image={finalImage}
  />
  
  <StructuredData 
    type="BlogPosting"
    title={post.title}
    description={post.description}
    author={author.name}
    publishDate={post.publishDate}
    image={finalImage}
    url={permalink}
  />

  <style>
    /* üõ°Ô∏è ZONA BLINDADA: DESIGN SYSTEM CORE */
    :root {
      --brand-blue: #75AADB;
      --accent-gold: #F4B942;
      --page-bg: #F8F9FA;
      --card-bg: #ffffff;
      --text-main: #2D3748;
      --text-muted: #718096;
      --text-prose: #4A5568;
      --card-border: #E2E8F0;
    }

    /* ‚ö†Ô∏è DARK MODE IMPORTANT
     * SIEMPRE usar :root[data-theme="dark"] NO @media (prefers-color-scheme: dark)
     * Esto asegura que el toggle manual de tema funcione correctamente
     * El selector :root[data-theme="dark"] se activa con DarkModeToggle.astro
     */
    :root[data-theme="dark"] {
      --page-bg: #0f172a;
      --card-bg: #1e293b;
      --text-main: #f1f5f9;
      --text-muted: #94a3b8;
      --text-prose: #cbd5e1;
      --card-border: #334155;
    }
    :root[data-theme="dark"] .share-icon.logo-mode { filter: invert(1); }
    /* üîì FIN DESIGN SYSTEM */

    body {
      margin: 0;
      background: var(--page-bg);
      font-family: 'Montserrat', sans-serif;
      color: var(--text-main);
      transition: background 0.3s ease, color 0.3s ease;
    }

    .container {
      max-width: 1900px;
      margin: 0 auto;
      padding: 0 1.5rem;
    }

    .layout {
      display: flex;
      flex-direction: column;
      gap: 3rem;
      margin-top: 2rem;
    }

    main {
      background: var(--card-bg);
      border-radius: 16px;
      border: 1px solid var(--card-border);
      overflow: hidden;
    }

    .hero { 
      width: 100%; 
      height: 450px;
      aspect-ratio: 16 / 9; /* üëà ESTA L√çNEA ES LA CLAVE */ 
      object-fit: cover; 
      margin-bottom: -0.25rem;
      animation: heroReveal 1s ease-out;
    }

    @keyframes heroReveal {
      from { opacity: 0; transform: scale(1.05); }
      to { opacity: 1; transform: scale(1); }
    }

    .content { 
      padding: 1.5rem 1.75rem 2.5rem;
      animation: fadeInUp 0.8s ease-out;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .back {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 1.5rem; 
      font-weight: 700; 
      color: var(--brand-blue);
      text-decoration: none; 
      font-size: 0.85rem; 
      text-transform: uppercase; 
      letter-spacing: 1px;
      padding: 0.5rem 1rem;
      border-radius: 50px;
      background: rgba(117, 170, 219, 0.1);
      transition: all 0.3s ease;
    }

    .back:hover {
      background: rgba(117, 170, 219, 0.2);
      transform: translateX(-4px);
    }

    h1 {
      font-size: clamp(2rem, 4vw, 3rem); 
      font-weight: 800; 
      margin: 0 0 1rem; 
      line-height: 1.15; 
      color: var(--text-main);
    }
    
    /* POST META INFO (Reading Time + Date) */
    .post-meta-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
      font-size: 0.85rem;
      color: var(--text-muted);
    }
    
    .meta-item {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }
    
    .meta-separator {
      opacity: 0.5;
    }

    /* HEADER DE AUTOR (MINI) - PREMIUM */
    .post-header-meta {
      display: flex; 
      align-items: center; 
      gap: 1rem; 
      margin-bottom: 2rem; 
      padding-bottom: 1.5rem; 
      border-bottom: 2px solid transparent;
      border-image: linear-gradient(90deg, var(--card-border), transparent) 1;
    }
    .mini-author { 
      display: flex; 
      align-items: center; 
      gap: 0.8rem;
      padding: 0.75rem;
      border-radius: 12px;
      transition: all 0.3s ease;
    }
    .mini-author:hover {
      background: rgba(117, 170, 219, 0.08);
    }
    
    .mini-author img { 
      width: 55px; 
      height: 55px; 
      border-radius: 50%; 
      object-fit: cover; 
      border: 3px solid var(--brand-blue);
      box-shadow: 0 4px 12px rgba(117, 170, 219, 0.25);
      transition: all 0.3s ease;
    }
    .mini-author:hover img {
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(117, 170, 219, 0.35);
    }
    
    .author-info { 
      display: flex; 
      flex-direction: column; 
      line-height: 1.4; 
      justify-content: center; 
    }
    
    .author-label { 
      font-size: 0.65rem; 
      color: var(--text-muted); 
      text-transform: uppercase; 
      letter-spacing: 0.5px; 
      font-weight: 700; 
    }
    
    .author-name { 
      font-weight: 700; 
      font-size: 1rem; 
      color: var(--text-main);
      transition: color 0.2s ease;
    }
    .mini-author:hover .author-name {
      color: var(--brand-blue);
    }
    
    .publish-date { 
      font-size: 0.7rem; 
      color: var(--text-muted); 
      text-transform: uppercase; 
      letter-spacing: 0.5px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .publish-date::before {
      content: 'üìÖ';
      font-size: 0.65rem;
    }


    /* ==========================================
       üõ°Ô∏è ZONA BLINDADA: FORMATO DE LECTURA (PROSE)
       üîí Ajuste Editorial Moderno: Espacios compactos y Links elegantes
       ========================================== */
    .prose {
      max-width: 780px; 
      margin: 0 auto; 
      font-size: 1.125rem; /* 18px */
      line-height: 1.55; 
      color: var(--text-prose); 
      font-family: 'IBM Plex Sans', sans-serif;
    }

    /* P√ÅRRAFOS */
    .prose :global(p) { margin-bottom: 1.25rem; }

    /* IM√ÅGENES & VIDEOS */
    .prose :global(img) { 
        max-width: 100%; height: auto; border-radius: 12px; 
        margin-top: 2rem; margin-bottom: 0.3rem; /* Pegado al cr√©dito */
        margin-left: auto; margin-right: auto; display: block; 
    }
    /* FIX IFRAMES (TikTok / iOS Safari) */
    .prose :global(iframe) {
        max-width: 100%;
        display: block;
        margin: 1.5rem auto;
        border-radius: 12px;
    }
    
    /* Responsive iframe container */
    .prose :global(iframe) {
        width: 100%;
        height: auto;
        aspect-ratio: 9 / 16; /* TikTok vertical */
        max-height: 80vh;
    }
    
    @media (max-width: 768px) {
        .prose :global(iframe) {
            max-height: 70vh;
        }
    }

    /* CR√âDITOS (Texto peque√±o) */
    .prose :global(.credit-style) {
        display: block; text-align: center; font-size: 0.85rem; color: var(--text-muted); 
        margin-top: 0; 
        margin-bottom: 1.5rem; /* Flujo compacto */
        font-style: italic; line-height: 1.4;
    }
    .prose :global(.credit-style a) {
        color: inherit !important; text-decoration: none !important; pointer-events: none; cursor: default;                  
    }

    /* TITULARES (H2, H3) - Estilo serio */
    .prose :global(h2), .prose :global(h3) { 
        margin-top: 2.5rem; margin-bottom: 1rem; 
        color: var(--text-main); /* Gris oscuro, no azul */
        font-weight: 800; font-family: 'Montserrat', sans-serif; line-height: 1.2;
    }

    /* LINKS (Editorial Suavizado) */
    .prose :global(a):not(.btn-ref):not(.affiliate-btn) { 
        color: var(--text-main); font-weight: 500; text-decoration: none; border-bottom: 2px solid var(--brand-blue); transition: all 0.2s ease;
    }
    .prose :global(a):not(.btn-ref):not(.affiliate-btn):hover { 
        background-color: rgba(117, 170, 219, 0.15); color: #000; border-bottom-color: transparent;
    }

    /* --- üî• LISTAS ELEGANTES (Compactas e Indentadas) --- */
    .prose :global(ul), .prose :global(ol) { 
        margin-bottom: 1.5rem; 
        padding-left: 2.5rem;  /* <--- Vi√±etas bien metidas a la derecha */
    }
    
    .prose :global(li) { 
        margin-bottom: 0.35rem; /* <--- Compacto: Menos salto entre l√≠neas */
        padding-left: 0.5rem;   
    }

    .prose :global(li::marker) {
        color: var(--brand-blue);      
        font-family: 'Montserrat', sans-serif; 
        font-weight: 800;              
        font-size: 1rem;               
    }
    /* ---------------------------------------------------- */

    /* BOT√ìN REFERIDO */
    .prose :global(.btn-ref) {
      display: inline-block; background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); color: #000 !important; font-weight: 800; padding: 0.75rem 1.5rem; border-radius: 8px; text-decoration: none !important; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transition: transform 0.2s, box-shadow 0.2s; margin: 1.5rem auto; border: 1px solid #eab308; text-align: center;
    }
    .prose :global(.btn-ref:hover) { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2); }
    /* üîì FIN ZONA PROSE */
    
    /* ---------------------------------------------------- */

    /* TARJETA DE REFERIDO (FRONTMATTER) */
    .affiliate-box {
        margin: 2.5rem 0; padding: 1.5rem;
        background: linear-gradient(135deg, rgba(244, 185, 66, 0.1) 0%, rgba(255,255,255,0) 100%);
        border-left: 4px solid var(--accent-gold); border-radius: 8px;
        display: flex; flex-direction: column; gap: 0.5rem;
    }
    .affiliate-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); font-weight: 700; }
    .affiliate-title { font-size: 1.1rem; font-weight: 800; color: var(--text-main); margin: 0; font-family: 'Montserrat', sans-serif; }
    .affiliate-btn {
        display: inline-block; margin-top: 0.5rem; background: var(--accent-gold); color: #1A202C;
        padding: 0.6rem 1.2rem; text-decoration: none; font-weight: 700; border-radius: 6px;
        align-self: flex-start; transition: transform 0.2s;
    }
    .affiliate-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(244, 185, 66, 0.3); }

    /* SHARE SECTION - PREMIUM */
    .share-section {
      margin-top: 4rem; 
      padding-top: 2rem; 
      border-top: 2px solid transparent;
      border-image: linear-gradient(90deg, transparent, var(--card-border), var(--card-border), transparent) 1;
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      gap: 1.5rem;
    }
    .share-title { 
      font-size: 0.8rem; 
      text-transform: uppercase; 
      letter-spacing: 2px; 
      color: var(--text-muted); 
      font-weight: 700;
    }
    .share-buttons { 
      display: flex; 
      gap: 0.75rem; 
    }
    .share-btn {
      display: flex; 
      align-items: center; 
      gap: 0.5rem; 
      padding: 0.7rem 1.4rem; 
      border-radius: 50px;
      text-decoration: none; 
      font-size: 0.8rem; 
      font-weight: 700; 
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
      color: white;
      letter-spacing: 0.5px;
    }
    .share-btn:hover { 
      transform: translateY(-3px) scale(1.02); 
    }
    .btn-facebook { 
      background: linear-gradient(135deg, #1877F2, #0d5bbf); 
    }
    .btn-facebook:hover {
      box-shadow: 0 8px 20px rgba(24, 119, 242, 0.4);
    }
    .btn-twitter { 
      background: linear-gradient(135deg, #000000, #333); 
    }
    .btn-twitter:hover {
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    }
    .btn-whatsapp { 
      background: linear-gradient(135deg, #25D366, #128C7E); 
    }
    .btn-whatsapp:hover {
      box-shadow: 0 8px 20px rgba(37, 211, 102, 0.4);
    }
    :root[data-theme="dark"] .btn-twitter { 
      background: linear-gradient(135deg, #ffffff, #e0e0e0); 
      color: black; 
    }

    /* SIDEBAR - PREMIUM */
    aside { 
      display: flex; 
      flex-direction: column; 
      gap: 1.5rem; 
    }
    .widget { 
      background: var(--card-bg); 
      border: 1px solid var(--card-border); 
      border-radius: 16px; 
      padding: 1.5rem; 
      color: var(--text-main);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .widget::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 16px;
      padding: 2px;
      background: linear-gradient(135deg, var(--accent-gold), var(--brand-blue));
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      opacity: 0;
      transition: opacity 0.4s ease;
    }
    .widget:hover::before {
      opacity: 1;
    }
    .widget:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 25px rgba(0, 0, 0, 0.08);
    }
    
    /* AUTOR SIDEBAR */
    .author-widget { text-align: center; }
    .author-widget img {
      width: 110px; 
      height: 110px; 
      border-radius: 50%; 
      object-fit: cover; 
      margin-bottom: 0.75rem;
      border: 4px solid var(--page-bg); 
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
      transition: all 0.4s ease;
    }
    .author-widget:hover img {
      transform: scale(1.05);
      box-shadow: 0 12px 30px rgba(117, 170, 219, 0.25);
    }
    .author-widget h3 { 
      margin: 0; 
      font-size: 1.15rem; 
      font-weight: 800; 
      color: var(--text-main); 
    }
    
    .author-role {
      font-size: 0.65rem; 
      color: var(--brand-blue); 
      text-transform: uppercase; 
      letter-spacing: 1px; 
      font-weight: 800; 
      margin-bottom: 1rem; 
      display: inline-block; 
      border: 1px solid var(--brand-blue); 
      padding: 6px 12px; 
      border-radius: 20px;
      background: rgba(117, 170, 219, 0.08);
      transition: all 0.3s ease;
    }
    .author-widget:hover .author-role {
      background: var(--brand-blue);
      color: white;
    }
    
    .author-widget p { 
      font-size: 0.9rem; 
      color: var(--text-muted); 
      line-height: 1.6; 
    }

    /* API PLACEHOLDER */
    .api-placeholder {
        border: 2px dashed var(--card-border); background: rgba(0,0,0,0.02);
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        text-align: center; min-height: 150px; color: var(--text-muted);
    }
    .api-icon { opacity: 0.5; margin-bottom: 0.5rem; }

    .widget h4 { font-size: 0.75rem; color: var(--brand-blue); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 0.75rem; font-weight: 800; }

    @media (min-width: 1024px) {
      .layout { 
        flex-direction: row; align-items: flex-start; justify-content: center;
      }
      
      main { flex: 1; max-width: 850px; } /* Limitar ancho para lectura c√≥moda */
      
      .right-sidebar { 
        width: 320px; position: sticky; top: 2rem; flex-shrink: 0;
      }
      
      .toc-sidebar { display: none; } /* Oculto en laptops normales */
      
      .content { padding: 2.5rem 4rem 4rem; }
    }

    @media (min-width: 1400px) {
        .toc-sidebar { 
            display: block; 
            width: 250px; 
            position: sticky; 
            top: 2rem; 
            flex-shrink: 0;
            margin-right: 1.5rem;
        }
    }
    /* FIX NEWSLETTER EN iOS */
    @media (max-width: 768px) {
        .prose > section,
        .prose > div {
            max-width: 100%;
        }

        .prose form {
            width: 100%;
        }
    }
/* ==========================
   FIXES iOS SAFARI
========================== */

@media (max-width: 768px) {
  .prose > section,
  .prose > div {
    max-width: 100%;
  }

  .prose form {
    width: 100%;
  }

 .prose :global(iframe) {
    aspect-ratio: 9 / 16;
  }
}

  </style>
</head>

<body>
  <ReadingProgress />
  <BackToTop />
  <ImageLightbox />
  <PWAInstallPrompt />
  <BlogHeader />

  <div class="container">
    <div class="layout">

      <!-- COLUMNA IZQUIERDA: TOC (Solo Desktop XL) -->
      <aside class="toc-sidebar">
         <TableOfContents />
      </aside>

      <main>
        {finalImage && (
          <img
            src={finalImage}
            alt={post.alt}
            class="hero"
            loading="eager"
          />
        )}

        <div class="content">
          <a href="/" class="back">‚Üê Volver al blog</a>
          
          <Breadcrumbs 
            items={[{ label: "Inicio", href: "/" }]}
            currentPage={post.title}
          />

          <h1>{post.title}</h1>
          
          <div class="post-meta-info">
            <span class="meta-item">üìñ {readingTime} min de lectura</span>
            <span class="meta-separator">‚Ä¢</span>
            <span class="meta-item">üìÖ {post.publishDate}</span>
          </div>

          <div class="post-header-meta">
            <div class="mini-author">
                <img src={author.image} alt={author.name} />
                <div class="author-info">
                    <span class="author-label">Este art√≠culo fue escrito por:</span>
                    <span class="author-name">{author.name}</span>
                    <span class="publish-date">{post.publishDate}</span>
                </div>
            </div>
          </div>

          <div class="prose" id="main-content">
            <AdBanner position="in-content" />

            <slot />

            {post.affiliateLink && (
                <div class="affiliate-box">
                    <span class="affiliate-label">Recomendaci√≥n de {author.name.split(' ')[0]}</span>
                    <p class="affiliate-title">{post.affiliateTitle || "Planea tu viaje aqu√≠"}</p>
                    <a href={post.affiliateLink} target="_blank" rel="noopener noreferrer" class="affiliate-btn">
                        {post.affiliateText} ‚Üí
                    </a>
                </div>
            )}

            {/* NEWSLETTER WIDGET (Retention Hook) */}
            <Newsletter variant="inline" />
            
            <AdBanner position="in-content" />
            
            {/* WIDGETS AUTOM√ÅTICOS SEG√öN DESTINO */}
            {post.flightDestination && (
                <div style="margin-top: 3rem; margin-bottom: 2rem;">
                    <FlightSearch variant="inline" destination={post.flightDestination} />
                </div>
            )}
            
            {post.tourCity && (
                <div style="margin-top: 2rem; margin-bottom: 2rem;">
                    <ToursWidget 
                        variant="inline" 
                        destination={post.tourCity} 
                        provider={toursProvider}
                        affiliateId={civitatisId} 
                    />
                </div>
            )}
          </div>
          
          <!-- Social Share -->
          <div class="article-share">
            <h3 class="share-heading">¬øTe sirvi√≥ este art√≠culo? Comp√°rtelo con otros viajeros ‚úàÔ∏è</h3>
            <SocialShare title={post.title} url={permalink} variant="inline" />
          </div>

        </div>
      </main>

      <aside class="right-sidebar">
        
        <div class="widget author-widget">
          <img src={author.image} alt={author.name} />
          <h3>{author.name}</h3>
          
          <span class="author-role">{authorRole}</span>
          
          <p>{authorBio}</p>
        </div>

        <FlightSearch variant="sidebar" affiliateTag={skyscannerTag} />

        <HotelWidget variant="sidebar" affiliateId={bookingId} />

        <ToursWidget variant="sidebar" affiliateId={civitatisId} provider={toursProvider} />

        <div class="widget" style="padding:0; border:none; background: transparent; text-align: center;">
          <AdBanner position="sidebar" />
        </div>
      </aside>

    </div>
  </div>

  <Footer />
  <Analytics />
</body>
</html>