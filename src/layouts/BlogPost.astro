---
// ==========================================
// üõ°Ô∏è ZONA BLINDADA: IMPORTS Y CONFIGURACI√ìN
// üîí No mover el orden de estos imports.
// ==========================================
import BaseHead from '../components/BaseHead.astro';
import BlogHeader from '../components/BlogHeader.astro';
import Footer from '../components/Footer.astro';
import AdBanner from '../components/AdBanner.astro';
import { AUTHORS, DEFAULT_AUTHOR } from '../data/authors';

const {
  content = {},
  frontmatter = {},
} = Astro.props;

// ==========================================
// üõ°Ô∏è ZONA BLINDADA: L√ìGICA DE NEGOCIO
// üîí Procesamiento de datos del post y autor
// ==========================================
const post = {
  title: frontmatter.title || content.title,
  description: frontmatter.description || content.description,
  publishDate: frontmatter.publishDate || content.publishDate,
  heroImage: frontmatter.heroImage || content.heroImage,
  heroImageLink: frontmatter.heroImageLink || content.heroImageLink,
  alt: frontmatter.alt || content.alt || frontmatter.title,
  authorSlug: frontmatter.author, 
  
  // Datos Referidos (Afiliados)
  affiliateTitle: frontmatter.affiliateTitle || content.affiliateTitle, 
  affiliateLink: frontmatter.affiliateLink || content.affiliateLink,
  affiliateText: frontmatter.affiliateText || "Reserva directa al mejor precio",
};

// Selecci√≥n de Autor (Fallback System)
const author = (post.authorSlug && AUTHORS[post.authorSlug]) || DEFAULT_AUTHOR;
const authorRole = author.role || "Colaborador"; 
const authorBio = author.bio || "Viajero y narrador de historias en Instante Trips.";

const finalImage = post.heroImage || post.heroImageLink;
const permalink = Astro.url.href;
const encodedUrl = encodeURIComponent(permalink);
const encodedTitle = encodeURIComponent(post.title);
// ==========================================
// üîì FIN ZONA L√ìGICA
// ==========================================
---

<html lang="es">
<head>
  <BaseHead
    title={post.title}
    description={post.description}
    permalink={permalink}
    image={finalImage}
  />

  <style>
    /* üõ°Ô∏è ZONA BLINDADA: DESIGN SYSTEM CORE */
    :root {
      --brand-blue: #75AADB;
      --accent-gold: #F4B942;
      --page-bg: #F8F9FA;
      --card-bg: #ffffff;
      --text-main: #2D3748;
      --text-muted: #718096;
      --text-prose: #4A5568;
      --card-border: #E2E8F0;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --page-bg: #0f172a;
        --card-bg: #1e293b;
        --text-main: #f1f5f9;
        --text-muted: #94a3b8;
        --text-prose: #cbd5e1;
        --card-border: #334155;
      }
      .share-icon.logo-mode { filter: invert(1); }
    }
    /* üîì FIN DESIGN SYSTEM */

    body {
      margin: 0;
      background: var(--page-bg);
      font-family: 'Montserrat', sans-serif;
      color: var(--text-main);
      transition: background 0.3s ease, color 0.3s ease;
    }

    .container {
      max-width: 1900px;
      margin: 0 auto;
      padding: 0 1.5rem;
    }

    .layout {
      display: flex;
      flex-direction: column;
      gap: 3rem;
      margin-top: 2rem;
    }

    main {
      background: var(--card-bg);
      border-radius: 16px;
      border: 1px solid var(--card-border);
      overflow: hidden;
    }

    .hero { width: 100%; height: 420px; object-fit: cover; margin-bottom: -0.25rem; }
    .content { padding: 1.5rem 1.75rem 2.5rem; }

    .back {
      display: inline-block; margin-bottom: 1.5rem; font-weight: 700; color: var(--brand-blue);
      text-decoration: none; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px;
    }

    h1 {
      font-size: clamp(2rem, 4vw, 3rem); font-weight: 800; margin: 0 0 1rem; line-height: 1.15; color: var(--text-main);
    }

    /* HEADER DE AUTOR (MINI) */
    .post-header-meta {
      display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--card-border);
    }
    .mini-author { display: flex; align-items: center; gap: 0.8rem; }
    
    .mini-author img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid var(--brand-blue); }
    
    .author-info { display: flex; flex-direction: column; line-height: 1.3; justify-content: center; }
    
    .author-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700; }
    
    .author-name { font-weight: 700; font-size: 0.95rem; color: var(--text-main); }
    .publish-date { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }


    /* ==========================================
       üõ°Ô∏è ZONA BLINDADA: FORMATO DE LECTURA (PROSE)
       üîí Ajuste Editorial Moderno: Espacios compactos y Links elegantes
       ========================================== */
    .prose {
      max-width: 780px; 
      margin: 0 auto; 
      font-size: 1.125rem; /* 18px */
      line-height: 1.4; 
      color: var(--text-prose); 
      font-family: 'IBM Plex Sans', sans-serif;
    }

    /* P√ÅRRAFOS */
    .prose :global(p) { margin-bottom: 1.25rem; }

    /* IM√ÅGENES & VIDEOS */
    .prose :global(img) { 
        max-width: 100%; height: auto; border-radius: 12px; 
        margin-top: 2rem; margin-bottom: 0.3rem; /* Pegado al cr√©dito */
        margin-left: auto; margin-right: auto; display: block; 
    }
    .prose :global(iframe) {
        width: 100%; max-width: 100%; aspect-ratio: 16 / 9; height: auto; 
        border-radius: 12px; margin-top: 2rem; margin-bottom: 0.3rem; 
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    /* CR√âDITOS (Texto peque√±o) */
    .prose :global(.credit-style) {
        display: block; text-align: center; font-size: 0.85rem; color: var(--text-muted); 
        margin-top: 0; 
        margin-bottom: 1.5rem; /* Flujo compacto */
        font-style: italic; line-height: 1.4;
    }
    .prose :global(.credit-style a) {
        color: inherit !important; text-decoration: none !important; pointer-events: none; cursor: default;                  
    }

    /* TITULARES (H2, H3) - Estilo serio */
    .prose :global(h2), .prose :global(h3) { 
        margin-top: 2.5rem; margin-bottom: 1rem; 
        color: var(--text-main); /* Gris oscuro, no azul */
        font-weight: 800; font-family: 'Montserrat', sans-serif; line-height: 1.2;
    }

    /* LINKS (Editorial Suavizado) */
    .prose :global(a):not(.btn-ref):not(.affiliate-btn) { 
        color: var(--text-main); font-weight: 500; text-decoration: none; border-bottom: 2px solid var(--brand-blue); transition: all 0.2s ease;
    }
    .prose :global(a):not(.btn-ref):not(.affiliate-btn):hover { 
        background-color: rgba(117, 170, 219, 0.15); color: #000; border-bottom-color: transparent;
    }

    /* --- üî• LISTAS ELEGANTES (Compactas e Indentadas) --- */
    .prose :global(ul), .prose :global(ol) { 
        margin-bottom: 1.5rem; 
        padding-left: 2.5rem;  /* <--- Vi√±etas bien metidas a la derecha */
    }
    
    .prose :global(li) { 
        margin-bottom: 0.35rem; /* <--- Compacto: Menos salto entre l√≠neas */
        padding-left: 0.5rem;   
    }

    .prose :global(li::marker) {
        color: var(--brand-blue);      
        font-family: 'Montserrat', sans-serif; 
        font-weight: 800;              
        font-size: 1rem;               
    }
    /* ---------------------------------------------------- */

    /* BOT√ìN REFERIDO */
    .prose :global(.btn-ref) {
      display: inline-block; background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); color: #000 !important; font-weight: 800; padding: 0.75rem 1.5rem; border-radius: 8px; text-decoration: none !important; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transition: transform 0.2s, box-shadow 0.2s; margin: 1.5rem auto; border: 1px solid #eab308; text-align: center;
    }
    .prose :global(.btn-ref:hover) { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2); }
    /* üîì FIN ZONA PROSE */
    
    /* ---------------------------------------------------- */

    /* TARJETA DE REFERIDO (FRONTMATTER) */
    .affiliate-box {
        margin: 2.5rem 0; padding: 1.5rem;
        background: linear-gradient(135deg, rgba(244, 185, 66, 0.1) 0%, rgba(255,255,255,0) 100%);
        border-left: 4px solid var(--accent-gold); border-radius: 8px;
        display: flex; flex-direction: column; gap: 0.5rem;
    }
    .affiliate-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); font-weight: 700; }
    .affiliate-title { font-size: 1.1rem; font-weight: 800; color: var(--text-main); margin: 0; font-family: 'Montserrat', sans-serif; }
    .affiliate-btn {
        display: inline-block; margin-top: 0.5rem; background: var(--accent-gold); color: #1A202C;
        padding: 0.6rem 1.2rem; text-decoration: none; font-weight: 700; border-radius: 6px;
        align-self: flex-start; transition: transform 0.2s;
    }
    .affiliate-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(244, 185, 66, 0.3); }

    /* SHARE SECTION */
    .share-section {
      margin-top: 4rem; padding-top: 2rem; border-top: 1px solid var(--card-border);
      display: flex; flex-direction: column; align-items: center; gap: 1.5rem;
    }
    .share-title { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 2px; color: var(--text-muted); font-weight: 700; }
    .share-buttons { display: flex; gap: 1rem; }
    .share-btn {
      display: flex; align-items: center; gap: 0.5rem; padding: 0.6rem 1.2rem; border-radius: 50px;
      text-decoration: none; font-size: 0.85rem; font-weight: 700; transition: transform 0.2s, opacity 0.2s; color: white;
    }
    .share-btn:hover { transform: translateY(-2px); opacity: 0.9; }
    .btn-facebook { background-color: #1877F2; }
    .btn-twitter { background-color: #000000; }
    .btn-whatsapp { background-color: #25D366; }
    @media (prefers-color-scheme: dark) { .btn-twitter { background-color: #ffffff; color: black; } }

    /* SIDEBAR */
    aside { display: flex; flex-direction: column; gap: 1.5rem; }
    .widget { background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 16px; padding: 1.5rem; color: var(--text-main); }
    
    /* AUTOR SIDEBAR */
    .author-widget { text-align: center; }
    .author-widget img {
      width: 110px; height: 110px; border-radius: 50%; object-fit: cover; margin-bottom: 0.75rem;
      border: 3px solid var(--page-bg); box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .author-widget h3 { margin: 0; font-size: 1.1rem; font-weight: 800; color: var(--text-main); }
    
    .author-role {
      font-size: 0.65rem; color: var(--brand-blue); text-transform: uppercase; letter-spacing: 1px; font-weight: 800; 
      margin-bottom: 1rem; display: inline-block; border: 1px solid var(--brand-blue); padding: 4px 8px; border-radius: 20px;
    }
    
    .author-widget p { font-size: 0.9rem; color: var(--text-muted); line-height: 1.5; }

    /* API PLACEHOLDER */
    .api-placeholder {
        border: 2px dashed var(--card-border); background: rgba(0,0,0,0.02);
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        text-align: center; min-height: 150px; color: var(--text-muted);
    }
    .api-icon { opacity: 0.5; margin-bottom: 0.5rem; }

    .widget h4 { font-size: 0.75rem; color: var(--brand-blue); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 0.75rem; font-weight: 800; }

   @media (min-width: 1024px) {
      .layout { 
        flex-direction: row; align-items: flex-start; 
      }
      
      main { flex: 1; }
      
      aside { 
        width: 320px; position: sticky; top: 2rem; 
      }
      
      .content { padding: 2.5rem 4rem 4rem; }
    }
  </style>
</head>

<body>
  <BlogHeader />

  <div class="container">
    <div class="layout">

      <main>
        {finalImage && (
          <img
            src={finalImage}
            alt={post.alt}
            class="hero"
            loading="eager"
          />
        )}

        <div class="content">
          <a href="/" class="back">‚Üê Volver al blog</a>

          <h1>{post.title}</h1>

          <div class="post-header-meta">
            <div class="mini-author">
                <img src={author.image} alt={author.name} />
                <div class="author-info">
                    <span class="author-label">Este art√≠culo fue escrito por:</span>
                    <span class="author-name">{author.name}</span>
                    <span class="publish-date">{post.publishDate}</span>
                </div>
            </div>
          </div>

          <div class="prose">
            <AdBanner position="in-content" />

            <slot />

            {post.affiliateLink && (
                <div class="affiliate-box">
                    <span class="affiliate-label">Recomendaci√≥n de {author.name.split(' ')[0]}</span>
                    <p class="affiliate-title">{post.affiliateTitle || "Planea tu viaje aqu√≠"}</p>
                    <a href={post.affiliateLink} target="_blank" rel="noopener noreferrer" class="affiliate-btn">
                        {post.affiliateText} ‚Üí
                    </a>
                </div>
            )}

            <AdBanner position="in-content" />
          </div>

          <div class="share-section">
            <span class="share-title">¬øTe sirvi√≥? Comp√°rtelo con otro viajero</span>
            <div class="share-buttons">
                <a href={`https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}`} target="_blank" class="share-btn btn-facebook">Facebook</a>
                <a href={`https://twitter.com/intent/tweet?url=${encodedUrl}&text=${encodedTitle}`} target="_blank" class="share-btn btn-twitter">X</a>
                <a href={`https://wa.me/?text=${encodedTitle} ${encodedUrl}`} target="_blank" class="share-btn btn-whatsapp">WhatsApp</a>
            </div>
          </div>

        </div>
      </main>

      <aside>
        
        <div class="widget author-widget">
          <img src={author.image} alt={author.name} />
          <h3>{author.name}</h3>
          
          <span class="author-role">{authorRole}</span>
          
          <p>{authorBio}</p>
        </div>

        <div class="widget">
            <h4>Planifica tu viaje</h4>
            <div class="api-placeholder">
                <div class="api-icon">‚úàÔ∏è üè® üó∫Ô∏è</div>
                <p style="font-size:0.8rem; margin:0;">
                    Pr√≥ximamente: Buscador de vuelos y hoteles integrado.
                </p>
            </div>
        </div>

        <div class="widget" style="padding:0; border:none; background: transparent; text-align: center;">
          <AdBanner position="sidebar" />
        </div>
      </aside>

    </div>
  </div>

  <Footer />
</body>
</html>